@using ITI.Gymunity.FP.Admin.MVC.ViewModels.Chat
@model ChatListViewModel

@{
    ViewData["Title"] = "Messages";
}

<div class="container-fluid px-4 py-4">
    <div class="row">
        <div class="col-lg-4 mb-4 mb-lg-0">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-comments"></i> Messages
                        @if (Model.TotalUnreadCount > 0)
                        {
                            <span class="badge bg-danger ms-2">@Model.TotalUnreadCount</span>
                        }
                    </h5>
                </div>
                <div class="card-body p-0">
                    @if (Model.Threads.Any())
                    {
                        <div id="threadsList" style="max-height: 600px; overflow-y: auto;">
                            @foreach (var thread in Model.Threads)
                            {
                                <div class="list-group-item list-group-item-action border-bottom cursor-pointer @(thread.UnreadCount > 0 ? "active" : "")" 
                                     onclick="loadThread(@thread.Id)" 
                                     style="cursor: pointer;">
                                    <div class="d-flex w-100 justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1 fw-bold">@(thread.ClientName ?? thread.TrainerName ?? "Unknown")</h6>
                                            <small class="text-muted">
                                                @(thread.LastMessageAt?.ToString("g") ?? "No messages")
                                            </small>
                                        </div>
                                        @if (thread.UnreadCount > 0)
                                        {
                                            <span class="badge bg-danger rounded-pill">@thread.UnreadCount</span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="p-4 text-center text-muted">
                            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>No conversations yet</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-body" id="chatArea">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>Select a conversation to start messaging</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.0/signalr.min.js"></script>
    <script>
        let currentThreadId = null;

        const chatHubConnection = new signalR.HubConnectionBuilder()
            .withUrl("/hubs/chat", {
                accessTokenFactory: () => localStorage.getItem('authToken') || ''
            })
            .withAutomaticReconnect()
            .build();

        chatHubConnection.start().catch(err => console.error(err));

        chatHubConnection.on("MessageReceived", (message) => {
            if (message.threadId === currentThreadId) {
                addMessageToChat(message);
            }
        });

        chatHubConnection.on("MessageMarkedAsRead", (messageId) => {
            const msgElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (msgElement) {
                msgElement.classList.remove('unread');
            }
        });

        chatHubConnection.on("ThreadMarkedAsRead", (threadId) => {
            const badge = document.querySelector(`[data-thread-id="${threadId}"] .badge`);
            if (badge) {
                badge.remove();
            }
        });

        chatHubConnection.on("UserOnline", (userId) => {
            console.log("User online:", userId);
            updateUserStatus(userId, true);
        });

        chatHubConnection.on("UserOffline", (userId) => {
            console.log("User offline:", userId);
            updateUserStatus(userId, false);
        });

        function loadThread(threadId) {
            currentThreadId = threadId;
            
            // Mark thread as selected
            document.querySelectorAll('.list-group-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.list-group-item').classList.add('active');

            // Load messages
            fetch(`/admin/chats/thread/${threadId}`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('chatArea').innerHTML = html;
                    
                    // Mark thread as read
                    chatHubConnection.invoke("MarkThreadAsRead", threadId);
                    
                    // Join the thread group
                    chatHubConnection.invoke("JoinThread", threadId);
                })
                .catch(error => console.error('Error:', error));
        }

        function addMessageToChat(message) {
            const chatContainer = document.getElementById('messagesList');
            if (chatContainer) {
                const messageHtml = `
                    <div class="message-item mb-3" data-message-id="${message.id}">
                        <div class="d-flex gap-3">
                            <img src="${message.senderProfilePhoto || '/images/default-avatar.png'}" 
                                 class="rounded-circle" width="40" height="40" alt="${message.senderName}">
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between">
                                    <strong>${message.senderName}</strong>
                                    <small class="text-muted">${new Date(message.createdAt).toLocaleString()}</small>
                                </div>
                                <p class="mb-0 mt-2">${message.content}</p>
                            </div>
                        </div>
                    </div>
                `;
                chatContainer.insertAdjacentHTML('beforeend', messageHtml);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content || !currentThreadId) return;

            fetch('/admin/chats/send-message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    threadId: currentThreadId,
                    content: content,
                    type: 0
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    input.value = '';
                    chatHubConnection.invoke("SendMessage", currentThreadId, {
                        content: content,
                        type: 0
                    });
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function updateUserStatus(userId, isOnline) {
            // Update user status indicators
            const statusElements = document.querySelectorAll(`[data-user-id="${userId}"]`);
            statusElements.forEach(el => {
                if (isOnline) {
                    el.classList.add('online');
                    el.classList.remove('offline');
                } else {
                    el.classList.remove('online');
                    el.classList.add('offline');
                }
            });
        }

        // Allow sending message with Enter key
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.target.id === 'messageInput') {
                sendMessage();
            }
        });
    </script>

    <style>
        .cursor-pointer {
            cursor: pointer;
        }

        .list-group-item.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        .message-item {
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .message-item.own {
            background-color: #e7f3ff;
            margin-left: 3rem;
        }

        #messageInput {
            border-radius: 20px;
            padding: 0.75rem 1.5rem;
        }

        .online::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #28a745;
            border-radius: 50%;
            right: 0;
            bottom: 0;
        }

        .offline::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #6c757d;
            border-radius: 50%;
            right: 0;
            bottom: 0;
        }
    </style>
}
