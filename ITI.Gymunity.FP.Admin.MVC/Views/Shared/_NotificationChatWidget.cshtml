<!-- Real-Time Notifications & Chat Widget -->
<!-- Notification Bell with Real-Time Badge -->
<div class="relative group">
    <button class="relative p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition" type="button" id="notificationDropdown" title="Notifications">
        <i class="fas fa-bell text-lg"></i>
        <span class="absolute top-1 right-1 hidden w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse" id="notificationBadgeIndicator"></span>
        <span class="absolute top-0 right-0 hidden min-w-fit h-5 px-2 text-xs font-bold text-white bg-red-500 rounded-full transform translate-x-1 -translate-y-1" id="notificationCount">0</span>
    </button>
    
    <!-- Notification Dropdown -->
    <div class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg border border-gray-200 hidden group-hover:block z-50 max-h-96 flex flex-col">
        <!-- Dropdown Header -->
        <div class="p-4 border-b border-gray-200 font-semibold text-gray-900 flex items-center justify-between">
            <span>Notifications</span>
            <button class="text-xs text-gray-500 hover:text-gray-700 px-2 py-1 rounded hover:bg-gray-100" onclick="markAllNotificationsAsRead()" id="markAllBtn" style="display: none;">
                Mark all as read
            </button>
        </div>
        
        <!-- Notification List -->
        <div class="overflow-y-auto flex-1" id="notificationDropdownList" style="max-height: 300px;">
            <div class="p-6 text-center text-sm text-gray-500">
                <i class="fas fa-inbox mb-2"></i>
                <p>No notifications yet</p>
            </div>
        </div>
        
        <!-- View All Link -->
        <div class="border-t border-gray-200">
            <a href="/admin/notifications" class="block text-center px-4 py-3 text-sm text-blue-600 hover:bg-gray-50 font-medium transition">
                View all notifications
            </a>
        </div>
    </div>
</div>

<!-- Chat Icon with Real-Time Badge -->
<a href="/admin/chats" class="relative p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition" title="Messages">
    <i class="fas fa-comments text-lg"></i>
    <span class="absolute top-0 right-0 hidden min-w-fit h-5 px-2 text-xs font-bold text-white bg-blue-500 rounded-full transform translate-x-1 -translate-y-1" id="chatCount">0</span>
</a>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.0/signalr.min.js"></script>

<script>
    // ============================================
    // SIGNALR CONNECTIONS & REAL-TIME UPDATES
    // ============================================
    
    // Initialize Admin Notification Hub Connection
    const adminNotificationConnection = new signalR.HubConnectionBuilder()
        .withUrl("/hubs/admin-notifications", {
            accessTokenFactory: () => localStorage.getItem('authToken') || ''
        })
        .withAutomaticReconnect()
        .build();

    // Initialize Chat Hub Connection
    const chatConnection = new signalR.HubConnectionBuilder()
        .withUrl("/hubs/chat", {
            accessTokenFactory: () => localStorage.getItem('authToken') || ''
        })
        .withAutomaticReconnect()
        .build();

    // Start connections
    adminNotificationConnection.start()
        .then(() => console.log('✓ Admin Notification Hub connected'))
        .catch(err => console.error('Admin Notification Hub connection error:', err));

    chatConnection.start()
        .then(() => console.log('✓ Chat Hub connected'))
        .catch(err => console.error('Chat Hub connection error:', err));

    // ============================================
    // NOTIFICATION HUB EVENT HANDLERS
    // ============================================

    adminNotificationConnection.on("AdminNotifications", (notifications) => {
        displayNotifications(notifications);
    });

    adminNotificationConnection.on("UnreadCount", (count) => {
        updateNotificationBadge(count);
    });

    adminNotificationConnection.on("NotificationBroadcast", (notification) => {
        console.log("Admin notification received:", notification);
        addNotificationToDropdown(notification);
        showNotificationAlert(notification);
    });

    adminNotificationConnection.on("UrgentAlert", (alert) => {
        showUrgentAlert(alert);
    });

    adminNotificationConnection.on("NotificationRead", (notificationId) => {
        const element = document.querySelector(`[data-notification-id="${notificationId}"]`);
        if (element) {
            element.classList.remove('bg-blue-50');
            element.classList.add('opacity-60');
        }
    });

    // ============================================
    // CHAT HUB EVENT HANDLERS
    // ============================================

    chatConnection.on("UserOnline", (userId) => {
        console.log("User online:", userId);
        updateUserStatus(userId, true);
    });

    chatConnection.on("UserOffline", (userId) => {
        console.log("User offline:", userId);
        updateUserStatus(userId, false);
    });

    // ============================================
    // NOTIFICATION MANAGEMENT FUNCTIONS
    // ============================================

    function updateNotificationBadge(count) {
        const badge = document.getElementById('notificationCount');
        const indicator = document.getElementById('notificationBadgeIndicator');
        const markAllBtn = document.getElementById('markAllBtn');
        
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.classList.remove('hidden');
            indicator.classList.remove('hidden');
            markAllBtn.style.display = 'block';
        } else {
            badge.classList.add('hidden');
            indicator.classList.add('hidden');
            markAllBtn.style.display = 'none';
        }
    }

    function displayNotifications(notifications) {
        const container = document.getElementById('notificationDropdownList');
        if (!notifications || notifications.length === 0) {
            container.innerHTML = `
                <div class="p-6 text-center text-sm text-gray-500">
                    <i class="fas fa-inbox mb-2"></i>
                    <p>No notifications yet</p>
                </div>
            `;
            return;
        }

        container.innerHTML = '';
        notifications.forEach(notification => {
            addNotificationToDropdown(notification);
        });
    }

    function addNotificationToDropdown(notification) {
        const container = document.getElementById('notificationDropdownList');
        
        // Clear empty state if showing
        if (container.innerHTML.includes('No notifications yet')) {
            container.innerHTML = '';
        }

        const isUnread = notification.isRead === false;
        const bgClass = isUnread ? 'bg-blue-50' : '';
        const notificationHTML = `
            <div class="notification-item border-b border-gray-100 last:border-b-0 p-4 hover:bg-gray-50 transition ${bgClass}" 
                 data-notification-id="${notification.id}">
                <div class="flex items-start justify-between gap-3">
                    <div class="flex-1">
                        <h6 class="font-semibold text-gray-900 text-sm">${escapeHtml(notification.title)}</h6>
                        <p class="text-gray-600 text-xs mt-1">${escapeHtml(notification.message)}</p>
                        <small class="text-gray-400 text-xs mt-2 block">
                            <i class="fas fa-clock mr-1"></i>${formatDateTime(notification.createdAt)}
                        </small>
                    </div>
                    ${isUnread ? `
                        <button class="text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 transition" 
                                onclick="markNotificationAsRead(${notification.id})" 
                                title="Mark as read">
                            <i class="fas fa-check text-sm"></i>
                        </button>
                    ` : `
                        <span class="text-xs text-gray-400">Read</span>
                    `}
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', notificationHTML);
    }

    function markNotificationAsRead(notificationId) {
        fetch(`/admin/notifications/mark-as-read/${notificationId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('[name="__RequestVerificationToken"]')?.value || ''
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                adminNotificationConnection.invoke("MarkAsRead", notificationId);
            }
        })
        .catch(error => console.error('Error marking notification as read:', error));
    }

    function markAllNotificationsAsRead() {
        fetch('/admin/notifications/mark-all-as-read', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('[name="__RequestVerificationToken"]')?.value || ''
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelectorAll('[data-notification-id]').forEach(item => {
                    item.classList.remove('bg-blue-50');
                    item.classList.add('opacity-60');
                });
                updateNotificationBadge(0);
            }
        })
        .catch(error => console.error('Error marking all as read:', error));
    }

    function showNotificationAlert(notification) {
        // Create a toast notification
        const alertDiv = document.createElement('div');
        alertDiv.className = 'fixed top-4 right-4 bg-white border-l-4 border-blue-600 rounded-lg shadow-lg p-4 max-w-sm animate-slideIn z-50';
        alertDiv.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="flex-1">
                    <h6 class="font-semibold text-gray-900 text-sm">${escapeHtml(notification.title)}</h6>
                    <p class="text-gray-600 text-xs mt-1">${escapeHtml(notification.message)}</p>
                </div>
                <button class="text-gray-400 hover:text-gray-600" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => alertDiv.remove(), 5000);
    }

    function showUrgentAlert(alert) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'fixed top-4 right-4 bg-red-50 border-l-4 border-red-600 rounded-lg shadow-lg p-4 max-w-sm animate-slideIn z-50';
        alertDiv.innerHTML = `
            <div class="flex items-start gap-3">
                <i class="fas fa-exclamation-circle text-red-600 mt-0.5 flex-shrink-0"></i>
                <div class="flex-1">
                    <h6 class="font-semibold text-red-900 text-sm">${escapeHtml(alert.title)}</h6>
                    <p class="text-red-700 text-xs mt-1">${escapeHtml(alert.message)}</p>
                </div>
                <button class="text-red-400 hover:text-red-600" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto-remove after 7 seconds
        setTimeout(() => alertDiv.remove(), 7000);
    }

    // ============================================
    // CHAT MANAGEMENT FUNCTIONS
    // ============================================

    function updateChatBadge(count) {
        const badge = document.getElementById('chatCount');
        const sidebarBadge = document.getElementById('chatBadgeSidebar');
        
        if (count > 0) {
            const displayCount = count > 99 ? '99+' : count;
            badge.textContent = displayCount;
            badge.classList.remove('hidden');
            
            if (sidebarBadge) {
                sidebarBadge.textContent = displayCount;
                sidebarBadge.classList.remove('hidden');
            }
        } else {
            badge.classList.add('hidden');
            if (sidebarBadge) {
                sidebarBadge.classList.add('hidden');
            }
        }
    }

    function updateUserStatus(userId, isOnline) {
        const statusElements = document.querySelectorAll(`[data-user-id="${userId}"]`);
        statusElements.forEach(el => {
            if (isOnline) {
                el.classList.add('online');
                el.classList.remove('offline');
            } else {
                el.classList.remove('online');
                el.classList.add('offline');
            }
        });
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDateTime(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
    }

    // ============================================
    // INITIALIZATION
    // ============================================

    // Load initial notification count and chat count
    window.addEventListener('load', () => {
        adminNotificationConnection.invoke("GetUnreadCount").catch(err => console.error(err));
        
        fetch('/admin/chats/unread-count')
            .then(response => response.json())
            .then(data => updateChatBadge(data.count))
            .catch(error => console.error('Error getting chat unread count:', error));
    });

    // Periodic refresh (every 30 seconds)
    setInterval(() => {
        adminNotificationConnection.invoke("GetUnreadCount").catch(err => console.error(err));
        fetch('/admin/chats/unread-count')
            .then(response => response.json())
            .then(data => updateChatBadge(data.count))
            .catch(error => console.error('Error:', error));
    }, 30000);

    // Add CSS for animations
    const style = document.createElement('style');
    style.textContent = `
        @@keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @@keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .animate-slideIn {
            animation: slideIn 0.3s ease-out;
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }

        .notification-item {
            cursor: pointer;
        }

        .notification-item:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }

        .online::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #10b981;
            border-radius: 50%;
            right: 0;
            bottom: 0;
            border: 2px solid white;
        }

        .offline::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #6b7280;
            border-radius: 50%;
            right: 0;
            bottom: 0;
            border: 2px solid white;
        }
    `;
    document.head.appendChild(style);
</script>
