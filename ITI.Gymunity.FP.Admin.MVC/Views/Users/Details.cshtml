@model ITI.Gymunity.FP.Admin.MVC.ViewModels.Users.UserDetailViewModel

@{
    ViewData["Title"] = $"User Details - {Model.User.FullName}";
}

<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-2">
                <i class="fas fa-user-circle text-blue-600"></i>
                <span>@Model.User.FullName</span>
            </h1>
            <p class="text-gray-500 mt-1">User account details and management</p>
        </div>
        <div class="flex gap-3">
            <a href="@Url.Action("Edit", new { userId = Model.User.Id })" class="inline-flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition">
                <i class="fas fa-edit"></i>
                <span>Edit</span>
            </a>
            <a href="@Url.Action("Index")" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                <i class="fas fa-arrow-left"></i>
                <span>Back</span>
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content Area -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Account Information -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
                    <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                        <i class="fas fa-info-circle"></i>
                        <span>Account Information</span>
                    </h3>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Full Name</label>
                            <p class="text-gray-900">@Model.User.FullName</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                            <p class="text-gray-900 break-all">@Model.User.Email</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                            <code class="bg-gray-100 px-3 py-1 rounded text-gray-700">@Model.User.UserName</code>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Phone Number</label>
                            <p class="text-gray-900">@(string.IsNullOrEmpty(Model.User.PhoneNumber) ? "Not provided" : Model.User.PhoneNumber)</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 pt-2 border-t border-gray-200">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Created At</label>
                            <p class="text-gray-900">@Model.User.CreatedAt.ToString("f")</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Last Login</label>
                            <p class="text-gray-900">
                                @if (Model.User.LastLoginAt.HasValue)
                                {
                                    @Model.User.LastLoginAt.Value.ToString("f")
                                }
                                else
                                {
                                    <span class="text-gray-500">Never logged in</span>
                                }
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Role & Security -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gradient-to-r from-green-600 to-green-700 px-6 py-4">
                    <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                        <i class="fas fa-shield-alt"></i>
                        <span>Role & Security</span>
                    </h3>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Primary Role</label>
                            <p class="text-gray-900">
                                <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium @GetRoleBadgeClass(Model.User.Role.ToString())">
                                    @GetRoleIcon(Model.User.Role.ToString())
                                    @Model.User.Role
                                </span>
                            </p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Assigned Roles</label>
                            <div class="space-y-1">
                                @if (Model.User.CurrentRoles.Any())
                                {
                                    @foreach (var role in Model.User.CurrentRoles)
                                    {
                                        <span class="inline-block px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm mr-2 mb-1">@role</span>
                                    }
                                }
                                else
                                {
                                    <span class="text-gray-500">No roles assigned</span>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 pt-4 border-t border-gray-200">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Email Confirmed</label>
                            @if (Model.User.EmailConfirmed)
                            {
                                <span class="inline-flex items-center gap-1 px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
                                    <i class="fas fa-check"></i> Yes
                                </span>
                            }
                            else
                            {
                                <span class="inline-flex items-center gap-1 px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-sm font-medium">
                                    <i class="fas fa-times"></i> No
                                </span>
                            }
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Account Verified</label>
                            @if (Model.User.IsVerified)
                            {
                                <span class="inline-flex items-center gap-1 px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
                                    <i class="fas fa-check-circle"></i> Verified
                                </span>
                            }
                            else
                            {
                                <span class="inline-flex items-center gap-1 px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-sm font-medium">
                                    <i class="fas fa-exclamation-circle"></i> Not Verified
                                </span>
                            }
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 pt-4 border-t border-gray-200">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Account Status</label>
                            @if (Model.User.IsLockedOut)
                            {
                                <span class="inline-flex items-center gap-1 px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-medium">
                                    <i class="fas fa-lock"></i> Locked Out
                                </span>
                            }
                            else
                            {
                                <span class="inline-flex items-center gap-1 px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
                                    <i class="fas fa-unlock"></i> Active
                                </span>
                            }
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Login Attempts</label>
                            <p class="text-gray-900 text-lg font-semibold">@Model.User.AccessFailedCount</p>
                        </div>
                    </div>

                    @if (Model.User.LockoutEnd.HasValue && Model.User.LockoutEnd > DateTimeOffset.UtcNow)
                    {
                        <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 flex items-start gap-3">
                            <i class="fas fa-exclamation-triangle flex-shrink-0 mt-0.5"></i>
                            <div>
                                <strong>Lockout Active</strong>
                                <p class="text-sm mt-1">Ends: @Model.User.LockoutEnd.Value.ToString("f")</p>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Trainer Information (if applicable) -->
            @if (Model.User.Role.ToString() == "Trainer")
            {
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-amber-600 to-amber-700 px-6 py-4">
                        <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                            <i class="fas fa-dumbbell"></i>
                            <span>Trainer Information</span>
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg text-blue-700 flex items-start gap-3">
                            <i class="fas fa-info-circle flex-shrink-0 mt-0.5"></i>
                            <div>Trainer profile and verification information would be displayed here.</div>
                        </div>
                        @if (!Model.User.IsVerified)
                        {
                            <form method="post" action="@Url.Action("VerifyTrainer", new { userId = Model.User.Id })" class="mt-4">
                                <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                    <i class="fas fa-check"></i>
                                    <span>Verify Trainer</span>
                                </button>
                            </form>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Side Panel - Actions & Status -->
        <div class="space-y-6">
            <!-- Profile Photo -->
            @if (!string.IsNullOrEmpty(Model.User.ProfilePhotoUrl))
            {
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <img src="@Model.User.ProfilePhotoUrl" class="w-full h-auto rounded-t-xl" alt="Profile Photo">
                </div>
            }

            <!-- Quick Actions -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gradient-to-r from-gray-900 to-gray-800 px-6 py-4">
                    <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                        <i class="fas fa-cogs"></i>
                        <span>Quick Actions</span>
                    </h3>
                </div>
                <div class="p-4 space-y-2">
                    <!-- Change Role Button -->
                    <button type="button" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2 justify-center text-sm font-medium" onclick="document.getElementById('changeRoleModal').style.display = 'flex'">
                        <i class="fas fa-user-tag"></i>
                        <span>Change Role</span>
                    </button>

                    <!-- Reset Password Button -->
                    <form method="post" action="@Url.Action("ResetPassword", new { userId = Model.User.Id })" class="w-full">
                        <button type="submit" class="w-full px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition flex items-center gap-2 justify-center text-sm font-medium" 
                                onclick="return confirm('Reset password for this user? They will need to reset it on next login.');">
                            <i class="fas fa-key"></i>
                            <span>Reset Password</span>
                        </button>
                    </form>

                    @if (!Model.User.IsLockedOut)
                    {
                        <!-- Lock Button -->
                        <button type="button" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition flex items-center gap-2 justify-center text-sm font-medium" onclick="document.getElementById('lockAccountModal').style.display = 'flex'">
                            <i class="fas fa-lock"></i>
                            <span>Lock Account</span>
                        </button>

                        <!-- Suspend Button -->
                        <button type="button" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition flex items-center gap-2 justify-center text-sm font-medium" onclick="document.getElementById('suspendAccountModal').style.display = 'flex'">
                            <i class="fas fa-ban"></i>
                            <span>Suspend Account</span>
                        </button>
                    }
                    else
                    {
                        <!-- Unlock Button -->
                        <form method="post" action="@Url.Action("UnlockAccount", new { userId = Model.User.Id })" class="w-full">
                            <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2 justify-center text-sm font-medium" 
                                    onclick="return confirm('Unlock this user account?');">
                                <i class="fas fa-unlock"></i>
                                <span>Unlock Account</span>
                            </button>
                        </form>

                        <!-- Reactivate Button -->
                        <form method="post" action="@Url.Action("Reactivate", new { userId = Model.User.Id })" class="w-full">
                            <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2 justify-center text-sm font-medium" 
                                    onclick="return confirm('Reactivate this user account?');">
                                <i class="fas fa-redo"></i>
                                <span>Reactivate</span>
                            </button>
                        </form>
                    }

                    <!-- Delete Button -->
                    <button type="button" class="w-full px-4 py-2 bg-red-700 text-white rounded-lg hover:bg-red-800 transition flex items-center gap-2 justify-center text-sm font-medium" onclick="document.getElementById('deleteUserModal').style.display = 'flex'">
                        <i class="fas fa-trash"></i>
                        <span>Delete User</span>
                    </button>
                </div>
            </div>

            <!-- Account Status Card -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 px-6 py-4">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-pulse"></i>
                        <span>Status Summary</span>
                    </h3>
                </div>
                <div class="p-6 space-y-4">
                    <div class="pb-4 border-b border-gray-200">
                        <span class="block text-sm font-semibold text-gray-700 mb-2">Email Status</span>
                        @if (Model.User.EmailConfirmed)
                        {
                            <span class="inline-flex items-center gap-1 px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium"><i class="fas fa-check"></i> Confirmed</span>
                        }
                        else
                        {
                            <span class="inline-flex items-center gap-1 px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-sm font-medium"><i class="fas fa-exclamation"></i> Unconfirmed</span>
                        }
                    </div>
                    <div class="pb-4 border-b border-gray-200">
                        <span class="block text-sm font-semibold text-gray-700 mb-2">Account Status</span>
                        @if (Model.User.IsLockedOut)
                        {
                            <span class="inline-flex items-center gap-1 px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-medium"><i class="fas fa-lock"></i> Locked</span>
                        }
                        else
                        {
                            <span class="inline-flex items-center gap-1 px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium"><i class="fas fa-check-circle"></i> Active</span>
                        }
                    </div>
                    <div>
                        <span class="block text-sm font-semibold text-gray-700 mb-2">Verification Status</span>
                        @if (Model.User.IsVerified)
                        {
                            <span class="inline-flex items-center gap-1 px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium"><i class="fas fa-shield-alt"></i> Verified</span>
                        }
                        else
                        {
                            <span class="inline-flex items-center gap-1 px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-sm font-medium"><i class="fas fa-exclamation-circle"></i> Unverified</span>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->

<!-- Change Role Modal -->
<div id="changeRoleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) this.style.display = 'none'">
    <div class="bg-white rounded-xl shadow-lg max-w-md w-full mx-4">
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                <i class="fas fa-user-tag"></i>
                <span>Change User Role</span>
            </h3>
        </div>
        <form method="post" action="@Url.Action("ChangeRole", new { userId = Model.User.Id })">
            <div class="p-6">
                <div class="mb-4">
                    <label for="newRole" class="block text-sm font-semibold text-gray-700 mb-2">Select New Role</label>
                    <select name="newRole" id="newRole" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        <option value="">-- Select a role --</option>
                        <option value="Client">Client</option>
                        <option value="Trainer">Trainer</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="border-t border-gray-200 px-6 py-4 flex gap-3 justify-end">
                <button type="button" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition" onclick="document.getElementById('changeRoleModal').style.display = 'none'">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Change Role</button>
            </div>
        </form>
    </div>
</div>

<!-- Lock Account Modal -->
<div id="lockAccountModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) this.style.display = 'none'">
    <div class="bg-white rounded-xl shadow-lg max-w-md w-full mx-4">
        <div class="bg-gradient-to-r from-amber-600 to-amber-700 px-6 py-4">
            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                <i class="fas fa-lock"></i>
                <span>Lock Account</span>
            </h3>
        </div>
        <form method="post" action="@Url.Action("LockAccount", new { userId = Model.User.Id })">
            <div class="p-6">
                <div class="mb-4">
                    <label for="duration" class="block text-sm font-semibold text-gray-700 mb-2">Lock Duration (minutes)</label>
                    <input type="number" name="durationMinutes" id="duration" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" value="30" required min="1">
                </div>
            </div>
            <div class="border-t border-gray-200 px-6 py-4 flex gap-3 justify-end">
                <button type="button" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition" onclick="document.getElementById('lockAccountModal').style.display = 'none'">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition">Lock Account</button>
            </div>
        </form>
    </div>
</div>

<!-- Suspend Account Modal -->
<div id="suspendAccountModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) this.style.display = 'none'">
    <div class="bg-white rounded-xl shadow-lg max-w-md w-full mx-4">
        <div class="bg-gradient-to-r from-red-600 to-red-700 px-6 py-4">
            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                <i class="fas fa-ban"></i>
                <span>Suspend Account</span>
            </h3>
        </div>
        <form method="post" action="@Url.Action("Suspend", new { userId = Model.User.Id })">
            <div class="p-6">
                <div class="mb-4">
                    <label for="reason" class="block text-sm font-semibold text-gray-700 mb-2">Reason for Suspension</label>
                    <textarea name="reason" id="reason" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" rows="4" required placeholder="Enter the reason for suspending this account..."></textarea>
                </div>
            </div>
            <div class="border-t border-gray-200 px-6 py-4 flex gap-3 justify-end">
                <button type="button" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition" onclick="document.getElementById('suspendAccountModal').style.display = 'none'">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Suspend Account</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete User Modal -->
<div id="deleteUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) this.style.display = 'none'">
    <div class="bg-white rounded-xl shadow-lg max-w-md w-full mx-4">
        <div class="bg-gradient-to-r from-red-600 to-red-700 px-6 py-4">
            <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                <i class="fas fa-trash"></i>
                <span>Delete User</span>
            </h3>
        </div>
        <form method="post" action="@Url.Action("Delete", new { userId = Model.User.Id })">
            <div class="p-6 space-y-4">
                <div class="p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 flex items-start gap-3">
                    <i class="fas fa-exclamation-triangle flex-shrink-0 mt-0.5"></i>
                    <div>
                        <strong>Warning:</strong>
                        <p class="text-sm mt-1">This action cannot be undone. The user account will be permanently deleted.</p>
                    </div>
                </div>
                <p class="text-gray-700">Are you sure you want to delete <strong>@Model.User.FullName</strong>?</p>
                <div class="flex items-center">
                    <input type="checkbox" name="confirm" id="confirmDelete" class="w-4 h-4 rounded border-gray-300 cursor-pointer" required>
                    <label for="confirmDelete" class="ml-2 text-sm text-gray-700">I understand this action is permanent</label>
                </div>
            </div>
            <div class="border-t border-gray-200 px-6 py-4 flex gap-3 justify-end">
                <button type="button" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition" onclick="document.getElementById('deleteUserModal').style.display = 'none'">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Delete User</button>
            </div>
        </form>
    </div>
</div>

@functions {
    private string GetRoleBadgeClass(string role)
    {
        return role switch
        {
            "Admin" => "bg-red-100 text-red-700",
            "Trainer" => "bg-amber-100 text-amber-700",
            "Client" => "bg-blue-100 text-blue-700",
            _ => "bg-gray-100 text-gray-700"
        };
    }

    private string GetRoleIcon(string role)
    {
        return role switch
        {
            "Admin" => "<i class=\"fas fa-shield-alt\"></i>",
            "Trainer" => "<i class=\"fas fa-dumbbell\"></i>",
            "Client" => "<i class=\"fas fa-user-circle\"></i>",
            _ => "<i class=\"fas fa-user\"></i>"
        };
    }
}
